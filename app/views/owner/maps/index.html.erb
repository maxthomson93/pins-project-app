<!-- app/views/owner/maps/index.html.erb -->

<div id="page-wrapper" data-controller="google-maps" data-markers="<%= (@markers || []).to_json %>">
  <!-- El mapa ocupa toda la pantalla -->
  <div id="map" style="width: 100%; height: 100vh;"></div>

  <!-- Tarjeta "My Maps" -->
  <div id="my-maps-container" class="collapsed">
    <!-- Cabecera (64px de alto) -->
    <div class="toggle-header" onclick="toggleMyMaps()" style="background-color: #E9EEE9;">
      <span class="tab-text">My Maps</span>
      <span id="toggle-icon">▲</span>
    </div>


  <div id="my-maps-content">
    <% colors = ["#1976D2", "#388E3C", "#FBC02D", "#D32F2F", "#7B1FA2", "#0288D1", "#C2185B"] %>
    <% images = [
      "fake_user1.jpeg",
      "fake_user2.jpeg",
      "fake_user3.jpeg",
      "fake_user4.jpeg",
      "fake_user6.jpeg",
      "fake_user8.jpeg",
      "fake_user9.jpeg"
    ] %>

    <% (@maps || []).each_with_index do |map, idx| %>
      <% color = colors[idx % colors.length] %>
      <div style="padding: 14px 16px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px;">

        <div style="display: flex; align-items: flex-start; justify-content: space-between;">
          <div style="flex: 1; padding-right: 12px;">
            <%= link_to map_path(map), class: "text-decoration-none", style: "text-decoration: none;" do %>
              <h3 style="margin: 0; font-size: 1.05rem; font-weight: 600; color: #222;"><%= map.name %></h3>
              <p style="margin: 4px 0 8px; font-size: 0.95rem; color: #666;"><%= map.description.presence || "No description" %></p>
            <% end %>
            <div style="display: flex; align-items: center; gap: 6px; font-size: 0.88rem; color: #555;">
              <i class="fa-solid fa-map-pin" style="color: #1976D2;"></i>
              <span><%= number_with_delimiter(map.pins.count) %> pins</span>
            </div>
          </div>

          <!-- Toggle -->
          <div class="pin-toggle checked <%= color %>-pin"
              data-action="click->google-maps#filterToggle"
              data-google-maps-target="pinsToggle"
              data-map-index="<%= idx %>"
              id="map_<%= idx %>"
              style="cursor: pointer; padding: 8px;">
            <i class="fa-solid fa-location-dot map-filter-icon" style="font-size: 1.2rem;"></i>
          </div>
        </div>

        <!-- Colaboradores -->
        <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
          <% if map.users.count > 0 %>
            <% map.users.limit(3).each_with_index do |user, i| %>
              <img src="<%= asset_path(images[i % images.length]) %>" alt="user" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.08);" />
            <% end %>
            <span style="font-size: 0.85rem; color: #888;"><%= number_with_delimiter(map.users.count) %></span>
          <% else %>
            <span style="font-size: 0.85rem; color: #aaa;">No collaborators</span>
          <% end %>
        </div>
      </div>
    <% end %>

  <% if (@maps || []).empty? %>
    <div style="text-align: center; color: #aaa; margin-top: 40px; font-size: 1.1rem;">
      No maps yet. Create your first map!
    </div>
  <% end %>
</div>


  <% if (@maps || []).empty? %>
    <div style="text-align: center; color: #aaa; margin-top: 40px; font-size: 1.1rem;">
      No maps yet. Create your first map!
    </div>
  <% end %>
</div>



<!-- JS para alternar collapsed/expanded -->
<script>
  function toggleMyMaps() {
    const container = document.getElementById("my-maps-container");
    const icon      = document.getElementById("toggle-icon");

    if (container.classList.contains("collapsed")) {
      container.classList.remove("collapsed");
      container.classList.add("expanded");
      icon.textContent = "▼";
    } else {
      container.classList.remove("expanded");
      container.classList.add("collapsed");
      icon.textContent = "▲";
    }
  }

  // Arranca siempre colapsado al cargar la página
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("my-maps-container");
    container.classList.add("collapsed");
    document.getElementById("toggle-icon").textContent = "▲";
  });
</script>
<%# <script>
  function toggleMyMaps() {
    const container = document.getElementById("my-maps-container");
    const icon      = document.getElementById("toggle-icon");

    if (container.classList.contains("collapsed")) {
      container.classList.remove("collapsed");
      container.classList.add("expanded");
      icon.textContent = "▼";
    } else {
      container.classList.remove("expanded");
      container.classList.add("collapsed");
      icon.textContent = "▲";
    }
  }

  // Siempre iniciar expandido, sin importar navegación previa
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("my-maps-container");
    container.classList.remove("collapsed");
    container.classList.add("expanded");
    document.getElementById("toggle-icon").textContent = "▼";
  });

  // También forzar expandido si se navega con Turbo/Hotwire (si aplica)
  document.addEventListener("turbo:load", () => {
    const container = document.getElementById("my-maps-container");
    if (container) {
      container.classList.remove("collapsed");
      container.classList.add("expanded");
      document.getElementById("toggle-icon").textContent = "▼";
    }
  });
</script> %>

<!-- Estilos embebidos -->
<style>
  body {
    margin: 0;
    padding: 0;
  }

  /* Contenedor flotante de My Maps */
  #my-maps-container {
    position: fixed;
    left: 0;
    bottom: 106px;           /* 106px por encima del footer */
    width: 100%;
    background-color: white;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    transition: height 0.3s ease;
    z-index: 9999;
  }

  /* Cuando está colapsado, solo muestra la cabecera de 64px */
  #my-maps-container.collapsed {
    height: 64px; /* Ajustado a 64px para que coincida justo encima del footer */
  }

  /* Cuando se expande, muestra cabecera + contenido (64px + 35vh) */
  #my-maps-container.expanded {
    height: calc(64px + 35vh);
  }

  /* Cabecera clickeable */
  .toggle-header {
    height: 64px; /* Altura real de la cabecera */
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    font-weight: bold;
    font-size: 1.2rem;
    cursor: pointer;
    border-top: 2px solid #eee;
  }

  .tab-text {
    font-size: 1.2rem;
  }

  /* Contenedor del listado de mapas */
  #my-maps-content {
    height: 35vh;        /* La lista ocupará máximo 35vh */
    overflow-y: auto;
    padding-bottom: 20px; /* Español: espacio para que el scroll no choque con el footer */
  }
</style>
